<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">

    
      <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net/; form-action 'self'; frame-src 'self'; img-src 'self'; object-src 'none'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/ https://cdn.jsdelivr.net/; script-src 'self' 'unsafe-inline' https://www.google-analytics.com https://cdn.jsdelivr.net/; prefetch-src 'self'; connect-src 'self' https://www.google-analytics.com;">

    

    <meta name="author" content="Sh0ckFR">
    <meta name="description" content="Martine à la recherche de la DLL Hijacking perdue">
    <meta name="keywords" content="redteam, red-team, infosec, security, pentest, forensics, ">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Martine à la recherche de la DLL Hijacking perdue"/>
<meta name="twitter:description" content="Martine à la recherche de la DLL Hijacking perdue"/>

    <meta property="og:title" content="Martine à la recherche de la DLL Hijacking perdue" />
<meta property="og:description" content="Martine à la recherche de la DLL Hijacking perdue" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://sh0ckfr.github.io/pages/martine-a-la-recherche-de-la-dll-hijacking-perdue/" /><meta property="article:section" content="pages" />
<meta property="article:published_time" content="2022-03-15T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-03-15T00:00:00+00:00" />



    <title>
  Martine à la recherche de la DLL Hijacking perdue · Sh0ckFR&#39;s Website | CyberPunk, Born in the binary world of the computer security
</title>

    
      <link rel="canonical" href="https://sh0ckfr.github.io/pages/martine-a-la-recherche-de-la-dll-hijacking-perdue/">
    

    <link rel="preload" href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as="font" type="font/woff2" crossorigin>

    
      
      
      <link rel="stylesheet" href="/css/coder.min.d9fddbffe6f27e69985dc5fe0471cdb0e57fbf4775714bc3d847accb08f4a1f6.css" integrity="" crossorigin="anonymous" media="screen" />
    

    

    
      
        
        
        <link rel="stylesheet" href="/css/coder-dark.min.002ee2378e14c7a68f1f0a53d9694ed252090987c4e768023fac694a4fc5f793.css" integrity="" crossorigin="anonymous" media="screen" />
      
    

    

    

    <link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

    <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

    <meta name="generator" content="Hugo 0.94.1" />
  </head>

  
  
    
  
  <body class="preload-transitions colorscheme-dark">
    
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        <li class="navigation-item">
          <a class="navigation-link" href="/">Accueil</a>
        </li>
        
          
            <li class="navigation-item">
              <a class="navigation-link" href="/pages/">Articles</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/about/">À propos</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container page">
  <article>
    <header>
      <h1 class="title">
        <a class="title-link" href="https://sh0ckfr.github.io/pages/martine-a-la-recherche-de-la-dll-hijacking-perdue/">
          Martine à la recherche de la DLL Hijacking perdue
        </a>
      </h1>
    </header>

    <p>Tout d&rsquo;abord, vous me pardonnerez pour le titre de l&rsquo;article, effectivement, durant mes recherches sur du <code>DLL Hijacking</code> un peu plus poussées que dans cet article, j&rsquo;avais l&rsquo;impression que Windows me faisait tourner en bourique, d&rsquo;où ce titre peu glorieux car j&rsquo;ai fail de nombreuses fois.</p>
<p>Nous allons tout de même voir la base dans cet article, le but ici est de vous donner un aperçu de ce qu&rsquo;est le DLL Hijacking et en quoi il peut être utile durant un exercice <code>Red-Team</code>, bien entendu tout comme moi, vous pourrez ensuite aller plus loin en vous intéressant au sujet, la technique n&rsquo;étant pas nouvelle, il y a tout de même pas assez de ressources à mon sens sur le sujet et donc beaucoup à faire.</p>
<p><img src="/images/martine-dll-hijacking.jpg" alt="Sh0ckFR DLL Hijacking Martine"></p>
<h2 id="quest-ce-que-le-dll-hijacking-">
  Qu&rsquo;est-ce que le DLL Hijacking ?
  <a class="heading-link" href="#quest-ce-que-le-dll-hijacking-">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>Sous Microsoft Windows, les applications ont besoin de tourner via des dépendances qui ont généralement l&rsquo;extension <code>.dll</code> pour <code>Dynamic Link Libraries</code>.</p>
<p>Pour vous faire une idée, une DLL se présente sous cette forme en C, ici une simple DLL qui va créer un Thread et afficher une MessageBox :</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ff0007;background-color:#0f140f;font-weight:bold;font-style:italic">#include</span> <span style="color:#ff0007;background-color:#0f140f;font-weight:bold;font-style:italic">&lt;windows.h&gt;</span><span style="color:#ff0007;background-color:#0f140f;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#ff0007;background-color:#0f140f;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#cdcaa9;font-weight:bold">int</span> <span style="color:#ff0086;font-weight:bold">Main</span>() {
</span></span><span style="display:flex;"><span>    MessageBoxW(<span style="color:#0086f7;font-weight:bold">0</span>, <span style="color:#0086d2">L</span><span style="color:#0086d2">&#34;hello c&#39;est moi Martine&#34;</span>, <span style="color:#0086d2">L</span><span style="color:#0086d2">&#34;Hello&#34;</span>, <span style="color:#0086f7;font-weight:bold">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">return</span> <span style="color:#0086f7;font-weight:bold">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BOOL APIENTRY <span style="color:#ff0086;font-weight:bold">DllMain</span>(HMODULE hModule,
</span></span><span style="display:flex;"><span>    DWORD  ul_reason_for_call,
</span></span><span style="display:flex;"><span>    LPVOID lpReserved
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">switch</span> (ul_reason_for_call)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">case</span> DLL_PROCESS_ATTACH:
</span></span><span style="display:flex;"><span>        CreateThread(NULL, NULL, (LPTHREAD_START_ROUTINE)Main, NULL, NULL, NULL);
</span></span><span style="display:flex;"><span>        <span style="color:#fb660a;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">case</span> DLL_THREAD_ATTACH:
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">case</span> DLL_THREAD_DETACH:
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">case</span> DLL_PROCESS_DETACH:
</span></span><span style="display:flex;"><span>        <span style="color:#fb660a;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">return</span> TRUE;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>C&rsquo;est bien beau mais j&rsquo;en fais quoi de ma DLL Martine ?</p>
<p>Pour l&rsquo;exemple, imaginez un programme <code>toto.exe</code> qui va au lancement charger sa DLL <code>tata.dll</code> pour effectuer une opération comme créer un fichier sur le disque avec une fonction du genre <code>CreateFile</code>.</p>
<p>Le but du DLL Hijacking est de se faire passer pour <code>tata.dll</code> via notre propre fichier DLL et ainsi exécuter notre code à la place de la fonction <code>CreateFile</code>.</p>
<p>Ce qui permet à un attaquant d&rsquo;utiliser un programme légitime voir même certifié par une autorité afin d&rsquo;exécuter du code malveillant, cela ne vous rappelle rien ?</p>
<p>Un petit indice : <a href="https://cyberint.com/blog/research/solarwinds-supply-chain-attack/">https://cyberint.com/blog/research/solarwinds-supply-chain-attack/</a></p>
<h2 id="cas-concret">
  Cas concret
  <a class="heading-link" href="#cas-concret">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>Nous allons prendre comme exemple <code>nslookup.exe</code> qui est un binaire natif présent sur Windows 10 et qui a été modifié pour la dernière fois en 2019.</p>
<p>Pour tester un DLL Hijacking, nous allons copier l&rsquo;exécutable dans un répertoire vide et tenter de l&rsquo;exécuter une première fois :</p>
<p><img src="/images/dll-hijacking1.png" alt="Sh0ckFR DLL Hijacking 1"></p>
<p>Dans mon cas je peux voir le nom de mon fournisseur d&rsquo;accès Internet et l&rsquo;adresse de ma box.</p>
<p>Et voilà ! fin de l&rsquo;article merci d&rsquo;être passé ! non je déconne :)</p>
<p>Nous allons maintenant nous intéresser aux fonctions dont à besoin le binaire pour fonctionner, pour cela nous allons utiliser l&rsquo;utilitaire <code>dumpbin.exe</code> disponible avec Visual Studio via le <code>x64 Native Command Tools</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>dumpbin /imports nslookup.exe
</span></span></code></pre></div><p>Nous avons comme résultat :</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Microsoft (R) COFF/PE Dumper Version 14.29.30136.0
</span></span><span style="display:flex;"><span>Copyright (C) Microsoft Corporation.  All rights reserved.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Dump of file nslookup.exe
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>File Type: EXECUTABLE IMAGE
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Section contains the following imports:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    msvcrt.dll
</span></span><span style="display:flex;"><span>             14000D448 Import Address Table
</span></span><span style="display:flex;"><span>             1400113D8 Import Name Table
</span></span><span style="display:flex;"><span>                     0 time date stamp
</span></span><span style="display:flex;"><span>                     0 Index of first forwarder reference
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                         4A0 putchar
</span></span><span style="display:flex;"><span>                         4B9 sprintf_s
</span></span><span style="display:flex;"><span>                         461 gmtime
</span></span><span style="display:flex;"><span>                         432 exit
</span></span><span style="display:flex;"><span>                         363 _vsnprintf
</span></span><span style="display:flex;"><span>                         304 _strnicmp
</span></span><span style="display:flex;"><span>                         439 fflush
</span></span><span style="display:flex;"><span>                         486 malloc
</span></span><span style="display:flex;"><span>                         ...
</span></span><span style="display:flex;"><span>    DNSAPI.dll
</span></span><span style="display:flex;"><span>             14000D238 Import Address Table
</span></span><span style="display:flex;"><span>             1400111C8 Import Name Table
</span></span><span style="display:flex;"><span>                     0 time date stamp
</span></span><span style="display:flex;"><span>                     0 Index of first forwarder reference
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                          45 DnsFreeConfigStructure
</span></span><span style="display:flex;"><span>                          75 DnsQueryConfigAllocEx
</span></span><span style="display:flex;"><span>    ...
</span></span></code></pre></div><p>Comme vous pouvez le voir, beaucoup de dépendances demandées par le binaire, notamment des librairies classiques qu&rsquo;on retrouve un peu partout comme <code>msvcrt.dll</code> dont les fonctions ne peuvent pas vraiment être détournées car faisant parties du système d&rsquo;exploitation.</p>
<p>Cependant on peut voir que des librairies comme <code>DNSAPI.dll</code> sont disponibles et que 2 fonctions <code>DnsFreeConfigStructure</code> et <code>DnsQueryConfigAllocEx</code> sont demandées par le programme.</p>
<p>Windows contient une clé de registre nommée <code>SafeDllSearchMode</code> disponible dans <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager</code>.</p>
<p>Quand notre programme est lancé, Windows va dire au programme en fonction de si cette clé est active ou non d&rsquo;aller chercher ses dépendances dans cet ordre.</p>
<p>Si le <code>SafeDllSearchMode</code> est actif :</p>
<ul>
<li>
<ol>
<li>Répertoire à partir duquel l’application a été chargée.</li>
</ol>
</li>
<li>
<ol start="2">
<li>Répertoire du système. Utilisez la fonction GetSystemDirectory pour récupérer le chemin d’accès à ce répertoire.</li>
</ol>
</li>
<li>
<ol start="3">
<li>Répertoire système 16 bits. Aucune fonction n’obtient le chemin d’accès de ce répertoire, mais elle est recherchée.</li>
</ol>
</li>
<li>
<ol start="4">
<li>répertoire Windows. Utilisez la fonction GetWindowsDirectory pour récupérer le chemin d’accès à ce répertoire.</li>
</ol>
</li>
<li>
<ol start="5">
<li>Le répertoire actif.</li>
</ol>
</li>
<li>
<ol start="6">
<li>Répertoires répertoriés dans la variable d’environnement PATH. Notez que cela n’inclut pas le chemin d’accès par application spécifié par la clé de Registre App Paths . La clé chemins d’accès à l’application n’est pas utilisée lors du calcul du chemin de recherche de dll.</li>
</ol>
</li>
</ul>
<p>Si <code>SafeDllSearchMode</code> est désactivé :</p>
<ul>
<li>
<ol>
<li>Répertoire à partir duquel l’application a été chargée.</li>
</ol>
</li>
<li>
<ol start="2">
<li>Le répertoire actif.</li>
</ol>
</li>
<li>
<ol start="3">
<li>Répertoire du système. Utilisez la fonction GetSystemDirectory pour récupérer le chemin d’accès à ce répertoire.</li>
</ol>
</li>
<li>
<ol start="4">
<li>Répertoire système 16 bits. Aucune fonction n’obtient le chemin d’accès de ce répertoire, mais elle est recherchée.</li>
</ol>
</li>
<li>
<ol start="5">
<li>répertoire Windows. Utilisez la fonction GetWindowsDirectory pour récupérer le chemin d’accès à ce répertoire.</li>
</ol>
</li>
<li>
<ol start="6">
<li>Répertoires répertoriés dans la variable d’environnement PATH. Notez que cela n’inclut pas le chemin d’accès par application spécifié par la clé de Registre App Paths . La clé chemins d’accès à l’application n’est pas utilisée lors du calcul du chemin de recherche de dll.</li>
</ol>
</li>
</ul>
<p>Vous pouvez retrouver cette information ici : <a href="https://docs.microsoft.com/fr-fr/windows/win32/dlls/dynamic-link-library-search-order">https://docs.microsoft.com/fr-fr/windows/win32/dlls/dynamic-link-library-search-order</a></p>
<p>Nous remarquons donc que dans les 2 cas, le programme va chercher ses dépendances dans le répertoire où l&rsquo;application a été chargée, il suffit donc de nommer notre dll <code>DNSAPI.dll</code> dans le même répertoire que <code>nslookup.exe</code> pour que celui-ci décide de la charger en priorité.</p>
<p>Testons donc de compiler notre DLL comme telle et lançons le programme.</p>
<p><img src="/images/dll-hijacking2.png" alt="Sh0ckFR dll Hijacking 2"></p>
<p>Et là c&rsquo;est le drame, ça ne fonctionne pas, avons-nous dit notre dernier mot Jean-Pierre ? pas forcément.</p>
<p>Testons de recompiler notre DLL en exportant la fonction <code>DnsFreeConfigStructure</code> :</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ff0007;background-color:#0f140f;font-weight:bold;font-style:italic">#include</span> <span style="color:#ff0007;background-color:#0f140f;font-weight:bold;font-style:italic">&lt;windows.h&gt;</span><span style="color:#ff0007;background-color:#0f140f;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#ff0007;background-color:#0f140f;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#cdcaa9;font-weight:bold">int</span> <span style="color:#ff0086;font-weight:bold">Main</span>() {
</span></span><span style="display:flex;"><span>    MessageBoxW(<span style="color:#0086f7;font-weight:bold">0</span>, <span style="color:#0086d2">L</span><span style="color:#0086d2">&#34;hello c&#39;est moi Martine&#34;</span>, <span style="color:#0086d2">L</span><span style="color:#0086d2">&#34;Hello&#34;</span>, <span style="color:#0086f7;font-weight:bold">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">return</span> <span style="color:#0086f7;font-weight:bold">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BOOL APIENTRY <span style="color:#ff0086;font-weight:bold">DllMain</span>(HMODULE hModule,
</span></span><span style="display:flex;"><span>    DWORD  ul_reason_for_call,
</span></span><span style="display:flex;"><span>    LPVOID lpReserved
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">switch</span> (ul_reason_for_call)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">case</span> DLL_PROCESS_ATTACH:
</span></span><span style="display:flex;"><span>        CreateThread(NULL, NULL, (LPTHREAD_START_ROUTINE)Main, NULL, NULL, NULL);
</span></span><span style="display:flex;"><span>        <span style="color:#fb660a;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">case</span> DLL_THREAD_ATTACH:
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">case</span> DLL_THREAD_DETACH:
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">case</span> DLL_PROCESS_DETACH:
</span></span><span style="display:flex;"><span>        <span style="color:#fb660a;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">return</span> TRUE;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fb660a;font-weight:bold">__declspec</span>(dllexport) <span style="color:#cdcaa9;font-weight:bold">void</span> DnsFreeConfigStructure() { Main(); }
</span></span></code></pre></div><p>On peut voir ici qu&rsquo;on a rajouté la fonction <code>DnsFreeConfigStructure</code> via le code <code>__declspec(dllexport) void DnsFreeConfigStructure() { Main(); }</code> qui aura pour but de lancer notre fonction <code>Main()</code> si la fonction est bien utilisée par le programme au lancement.</p>
<p><img src="/images/dll-hijacking3.png" alt="Sh0ckFR dll Hijacking 3"></p>
<p>Toujours un fail mais on a du mieux, on peut voir via le message d&rsquo;erreur que le programme demande aussi la fonction <code>DnsQueryConfigAllocEx</code> pour se lancer, rajoutons la :</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ff0007;background-color:#0f140f;font-weight:bold;font-style:italic">#include</span> <span style="color:#ff0007;background-color:#0f140f;font-weight:bold;font-style:italic">&lt;windows.h&gt;</span><span style="color:#ff0007;background-color:#0f140f;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#ff0007;background-color:#0f140f;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#cdcaa9;font-weight:bold">int</span> <span style="color:#ff0086;font-weight:bold">Main</span>() {
</span></span><span style="display:flex;"><span>    MessageBoxW(<span style="color:#0086f7;font-weight:bold">0</span>, <span style="color:#0086d2">L</span><span style="color:#0086d2">&#34;hello c&#39;est moi Martine&#34;</span>, <span style="color:#0086d2">L</span><span style="color:#0086d2">&#34;Hello&#34;</span>, <span style="color:#0086f7;font-weight:bold">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">return</span> <span style="color:#0086f7;font-weight:bold">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BOOL APIENTRY <span style="color:#ff0086;font-weight:bold">DllMain</span>(HMODULE hModule,
</span></span><span style="display:flex;"><span>    DWORD  ul_reason_for_call,
</span></span><span style="display:flex;"><span>    LPVOID lpReserved
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">switch</span> (ul_reason_for_call)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">case</span> DLL_PROCESS_ATTACH:
</span></span><span style="display:flex;"><span>        CreateThread(NULL, NULL, (LPTHREAD_START_ROUTINE)Main, NULL, NULL, NULL);
</span></span><span style="display:flex;"><span>        <span style="color:#fb660a;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">case</span> DLL_THREAD_ATTACH:
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">case</span> DLL_THREAD_DETACH:
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">case</span> DLL_PROCESS_DETACH:
</span></span><span style="display:flex;"><span>        <span style="color:#fb660a;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">return</span> TRUE;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fb660a;font-weight:bold">__declspec</span>(dllexport) <span style="color:#cdcaa9;font-weight:bold">void</span> DnsFreeConfigStructure() { Main(); }
</span></span><span style="display:flex;"><span><span style="color:#fb660a;font-weight:bold">__declspec</span>(dllexport) <span style="color:#cdcaa9;font-weight:bold">void</span> DnsQueryConfigAllocEx() { Main(); }
</span></span></code></pre></div><p>Bingo Martine a trouvée la DLL Hijacking perdue dans <code>nslookup.exe</code> !</p>
<p><img src="/images/dll-hijacking4.png" alt="Sh0ckFR dll Hijacking 4"></p>
<p>On peut voir que 2 MessageBox s&rsquo;affichent donc que 2 fonctions sont exécutées, potentiellement <code>DnsFreeConfigStructure</code> et <code>DnsQueryConfigAllocEx</code> ou bien <code>DnsQueryConfigAllocEx</code> et <code>DllMain</code> qui est le point d&rsquo;entrée de notre DLL.</p>
<p>Je vous donne la réponse, il s&rsquo;agit de <code>DnsQueryConfigAllocEx</code> et <code>DllMain</code>.</p>
<p><code>nslookup.exe</code> n&rsquo;ayant pas de certificat Microsoft mais étant tout de même un binaire de Windows natif, cela peut être utile, cependant vu qu&rsquo;une command line s&rsquo;ouvre au lancement, il n&rsquo;est malheureusement pas vraiment utilisable dans le cadre d&rsquo;un exercice Red-Team.</p>
<p>Cependant beaucoup de binaires ne lancent pas forcément de fenêtres à l&rsquo;exécution et sont parfois signés par les développeurs.</p>
<p>On peut imaginer exécuter un beacon <code>Cobalt-Strike</code> à la place de notre simple MessageBox dans une situation réelle.</p>
<h2 id="mot-de-la-fin">
  Mot de la fin
  <a class="heading-link" href="#mot-de-la-fin">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>Comme vous avez pu le voir, le DLL Hijacking permet notamment d&rsquo;exécuter du code malveillant via des programmes légitimes et permet donc d&rsquo;augmenter la furtivité d&rsquo;un attaquant en particulier si celui-ci passe par un binaire signé par un éditeur.</p>
<p>Cette méthode est utilisée par des opérateurs Red-Team mais également par des acteurs malveillants, il est également possible d&rsquo;utiliser Process Monitor avec le filtre <code>Result</code> sur <code>NAME NOT FOUND</code> pour observer des binaires recherchant leurs DLL perdues.</p>
<p><a href="https://pentestlab.blog/2017/03/27/dll-hijacking/">https://pentestlab.blog/2017/03/27/dll-hijacking/</a></p>
<p>Notez également que certains programmes demandent des privilèges Administrateur pour être exécutés donc ne sont pas utilisables si vous possédez un simple compte utilisateur durant votre exercice.</p>

  </article>
</section>

  

      </div>

      <footer class="footer">
</footer>

    </main>

    
      
      <script src="/js/coder.min.8fb86376a16e684af472a329aef502dbebcfab65ce264e9750d144912947c602.js" integrity=""></script>
    

    

    

    

    

    

    

    

    
  </body>

</html>
